# Vercel Deployment Setup Guide

## Prerequisites

- Git repository (GitHub, GitLab, or Bitbucket)
- Vercel account (sign up at https://vercel.com)
- Vercel CLI installed globally: `npm i -g vercel`

## Step 1: Link Project with Vercel CLI

### 1.1 Login to Vercel

```bash
vercel login
```

Follow the prompts to authenticate with your Vercel account.

### 1.2 Link the Project

Navigate to the frontend directory and link the project:

```bash
cd frontend
vercel link
```

You'll be prompted to:
- Select your Vercel scope (personal or team)
- Link to an existing project or create a new one
- Confirm the project settings

**Recommended Settings:**
- Project Name: `ncskit` or `ncskit-frontend`
- Framework Preset: Next.js
- Root Directory: `./` (if running from frontend folder)
- Build Command: `npm run build`
- Output Directory: `.next`
- Install Command: `npm install`

### 1.3 Verify Link

Check that the project is linked:

```bash
vercel ls
```

You should see your project listed.

## Step 2: Configure Environment Variables in Vercel Dashboard

### 2.1 Access Environment Variables

1. Go to https://vercel.com/dashboard
2. Select your project
3. Navigate to **Settings** ‚Üí **Environment Variables**

### 2.2 Add Required Environment Variables

Add the following environment variables for **Production**, **Preview**, and **Development** environments:

#### Supabase Configuration

```
NEXT_PUBLIC_SUPABASE_URL
Value: https://your-project.supabase.co
Environments: Production, Preview, Development
```

```
NEXT_PUBLIC_SUPABASE_ANON_KEY
Value: your-supabase-anon-key
Environments: Production, Preview, Development
```

```
SUPABASE_SERVICE_ROLE_KEY
Value: your-supabase-service-role-key
Environments: Production, Preview, Development
‚ö†Ô∏è SENSITIVE - Keep this secret!
```

#### Analytics Service Configuration

```
NEXT_PUBLIC_ANALYTICS_URL
Value (Production): https://analytics.ncskit.app
Value (Preview): http://localhost:8000
Value (Development): http://localhost:8000
Environments: Production, Preview, Development
```

```
ANALYTICS_API_KEY
Value: Generate a strong random key (use: openssl rand -base64 32)
Environments: Production, Preview, Development
‚ö†Ô∏è SENSITIVE - Keep this secret!
```

#### App Configuration

```
NEXT_PUBLIC_APP_URL
Value (Production): https://ncskit.vercel.app (or your custom domain)
Value (Preview): Auto-generated by Vercel
Value (Development): http://localhost:3000
Environments: Production, Preview, Development
```

```
NODE_ENV
Value: production
Environments: Production only
```

#### Optional: Monitoring & Error Tracking

```
SENTRY_DSN
Value: your-sentry-dsn (if using Sentry)
Environments: Production, Preview
```

```
SLACK_WEBHOOK_URL
Value: your-slack-webhook-url (for health check alerts)
Environments: Production
```

### 2.3 Using Vercel CLI to Add Environment Variables

Alternatively, you can add environment variables via CLI:

```bash
# Add production environment variable
vercel env add NEXT_PUBLIC_SUPABASE_URL production

# Add to all environments
vercel env add ANALYTICS_API_KEY production preview development

# Pull environment variables to local
vercel env pull .env.local
```

## Step 3: Configure Deployment Settings

### 3.1 Git Integration

1. In Vercel Dashboard ‚Üí **Settings** ‚Üí **Git**
2. Connect your Git repository
3. Configure:
   - **Production Branch**: `main` or `master`
   - **Preview Branches**: All branches (or specific branches)
   - **Automatic Deployments**: Enabled

### 3.2 Build & Development Settings

In **Settings** ‚Üí **General**:

- **Framework Preset**: Next.js
- **Root Directory**: `frontend` (if monorepo) or `./` (if frontend is root)
- **Build Command**: `npm run build`
- **Output Directory**: `.next`
- **Install Command**: `npm install`
- **Development Command**: `npm run dev`

### 3.3 Function Configuration

The `vercel.json` file already configures function settings:

- API routes: 30s timeout, 1024MB memory
- Analytics routes: 60s timeout, 1024MB memory
- Health check routes: 10s timeout, 512MB memory

### 3.4 Domain Configuration

1. In **Settings** ‚Üí **Domains**
2. Add your custom domain (if you have one)
3. Configure DNS records as instructed by Vercel

**Default Domain**: `your-project.vercel.app`
**Custom Domain**: `ncskit.app` (example)

### 3.5 Deployment Protection (Optional)

For production protection:

1. **Settings** ‚Üí **Deployment Protection**
2. Enable **Vercel Authentication** for preview deployments
3. Add team members who can access previews

## Step 4: Verify Configuration

### 4.1 Check Environment Variables

```bash
# List all environment variables
vercel env ls

# Pull environment variables to verify
vercel env pull .env.vercel
```

### 4.2 Test Build Locally

Before deploying, test the build locally:

```bash
# Install dependencies
npm install

# Run environment validation
npm run validate-env

# Build the project
npm run build

# Test production build locally
npm run start
```

### 4.3 Deploy to Preview

Test deployment to a preview environment:

```bash
vercel
```

This creates a preview deployment. Check:
- Build logs for errors
- Preview URL works correctly
- Environment variables are loaded
- API routes are accessible

## Step 5: Configure Vercel Project Settings

### 5.1 Performance Settings

In **Settings** ‚Üí **Performance**:

- **Edge Functions**: Enabled (for faster API responses)
- **Image Optimization**: Enabled
- **Compression**: Enabled (gzip/brotli)

### 5.2 Security Settings

In **Settings** ‚Üí **Security**:

- **Deployment Protection**: Configure as needed
- **Secure Compute**: Enabled (if available)
- **DDoS Protection**: Enabled by default

### 5.3 Analytics & Monitoring

In **Analytics** tab:

- Enable **Vercel Analytics** for web vitals
- Enable **Speed Insights** for performance monitoring
- Configure **Log Drains** (optional) for centralized logging

## Step 6: Setup Deployment Webhooks (Optional)

For notifications on deployment events:

1. **Settings** ‚Üí **Git** ‚Üí **Deploy Hooks**
2. Create a deploy hook
3. Use the webhook URL in your CI/CD or notification system

Example: Slack notification on deployment

```bash
curl -X POST https://hooks.slack.com/services/YOUR/WEBHOOK/URL \
  -H 'Content-Type: application/json' \
  -d '{
    "text": "üöÄ NCSKIT deployed to production!",
    "blocks": [
      {
        "type": "section",
        "text": {
          "type": "mrkdwn",
          "text": "*Deployment Status:* Success\n*Environment:* Production\n*URL:* https://ncskit.vercel.app"
        }
      }
    ]
  }'
```

## Step 7: Configure Cron Jobs (Optional)

The `vercel.json` already configures a health check cron:

```json
"crons": [
  {
    "path": "/api/health/check",
    "schedule": "*/5 * * * *"
  }
]
```

This runs every 5 minutes. Verify in **Settings** ‚Üí **Cron Jobs**.

## Troubleshooting

### Build Fails

1. Check build logs in Vercel Dashboard
2. Verify environment variables are set correctly
3. Test build locally: `npm run build`
4. Check for missing dependencies

### Environment Variables Not Loading

1. Verify variables are added to correct environment (Production/Preview/Development)
2. Redeploy after adding new variables
3. Check variable names match exactly (case-sensitive)

### API Routes Timeout

1. Increase timeout in `vercel.json` functions config
2. Check if Docker analytics service is running
3. Verify Cloudflare Tunnel is active

### Preview Deployments Not Working

1. Check Git integration is connected
2. Verify branch is not ignored in settings
3. Check deployment protection settings

## Next Steps

After completing Vercel setup:

1. ‚úÖ Verify all environment variables are configured
2. ‚úÖ Test preview deployment
3. ‚û°Ô∏è Proceed to Task 10.2: Deploy to Production
4. ‚û°Ô∏è Monitor deployment health checks

## Useful Commands

```bash
# Deploy to production
vercel --prod

# Deploy to preview
vercel

# View deployment logs
vercel logs <deployment-url>

# List all deployments
vercel ls

# Remove a deployment
vercel rm <deployment-url>

# Open project in browser
vercel open

# Check project info
vercel inspect
```

## Resources

- [Vercel Documentation](https://vercel.com/docs)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [Environment Variables](https://vercel.com/docs/concepts/projects/environment-variables)
- [Vercel CLI Reference](https://vercel.com/docs/cli)
